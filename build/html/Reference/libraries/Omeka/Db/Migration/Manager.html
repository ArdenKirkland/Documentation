

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Omeka_Db_Migration_Manager &mdash; Omeka Documentation v2.0 documentation</title>
    <link rel="stylesheet" href="../../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    
    <link rel="top" title="Omeka Documentation v2.0 documentation" href="../../../../../index.html" />
    <link rel="stylesheet" href="../../../../../_static/overrides.css" type="text/css" />
 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
    
        <li><a href="../../../../../index.html">Omeka Documentation v2.0 documentation</a> &raquo;</li>
    <p style="background-color: white; color:red;">
    This documentation is currently unstable as changes continue to be made to Omeka 2.0.    
     The final release of Omeka 2.0 may have changes.</p>    
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="omeka-db-migration-manager">
<h1>Omeka_Db_Migration_Manager<a class="headerlink" href="#omeka-db-migration-manager" title="Permalink to this headline">¶</a></h1>
<dl class="class">
<dt id="Omeka_Db_Migration_Manager">
<em class="property">class </em><tt class="descname">Omeka_Db_Migration_Manager</tt><a class="headerlink" href="#Omeka_Db_Migration_Manager" title="Permalink to this definition">¶</a></dt>
<dd><p>Package: <a class="reference internal" href="../../../../packages/Db/Migration/index.html"><em>Db\Migration</em></a></p>
<p>Manages database migrations (both upgrades and downgrades).</p>
<dl class="const">
<dt id="Omeka_Db_Migration_Manager::MIGRATION_TABLE_NAME">
<em class="property">constant </em><tt class="descname">MIGRATION_TABLE_NAME</tt><a class="headerlink" href="#Omeka_Db_Migration_Manager::MIGRATION_TABLE_NAME" title="Permalink to this definition">¶</a></dt>
<dd><p>Name of the migrations table.</p>
</dd></dl>

<dl class="const">
<dt id="Omeka_Db_Migration_Manager::MIGRATION_DATE_FORMAT">
<em class="property">constant </em><tt class="descname">MIGRATION_DATE_FORMAT</tt><a class="headerlink" href="#Omeka_Db_Migration_Manager::MIGRATION_DATE_FORMAT" title="Permalink to this definition">¶</a></dt>
<dd><p>Formatting string to convert dates into YYYYMMDDHHMMSS pattern.</p>
</dd></dl>

<dl class="const">
<dt id="Omeka_Db_Migration_Manager::ORIG_MIGRATION_OPTION_NAME">
<em class="property">constant </em><tt class="descname">ORIG_MIGRATION_OPTION_NAME</tt><a class="headerlink" href="#Omeka_Db_Migration_Manager::ORIG_MIGRATION_OPTION_NAME" title="Permalink to this definition">¶</a></dt>
<dd><p>Name of the original database option storing the integer migration number.</p>
</dd></dl>

<dl class="const">
<dt id="Omeka_Db_Migration_Manager::VERSION_OPTION_NAME">
<em class="property">constant </em><tt class="descname">VERSION_OPTION_NAME</tt><a class="headerlink" href="#Omeka_Db_Migration_Manager::VERSION_OPTION_NAME" title="Permalink to this definition">¶</a></dt>
<dd><p>Name of the new database option storing the core software version number.</p>
</dd></dl>

<dl class="attr">
<dt id="Omeka_Db_Migration_Manager::$_db">
<em class="property">property </em><tt class="descname">_db</tt><a class="headerlink" href="#Omeka_Db_Migration_Manager::$_db" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="attr">
<dt id="Omeka_Db_Migration_Manager::$_migrationsDir">
<em class="property">property </em><tt class="descname">_migrationsDir</tt><a class="headerlink" href="#Omeka_Db_Migration_Manager::$_migrationsDir" title="Permalink to this definition">¶</a></dt>
<dd><p>Directory where migrations scripts are kept.</p>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::__construct">
<tt class="descname">__construct</tt><big>(</big><em>Omeka_Db $db</em>, <em>string $migrationsDir</em><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::__construct" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>$db</strong> (<a class="reference internal" href="../../Db.html#Omeka_Db" title="Omeka_Db"><em>Omeka_Db</em></a>) &#8211; </li>
<li><strong>$migrationsDir</strong> (<em>string</em>) &#8211; </li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::setupTimestampMigrations">
<tt class="descname">setupTimestampMigrations</tt><big>(</big><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::setupTimestampMigrations" title="Permalink to this definition">¶</a></dt>
<dd><p>Set up Omeka to use timestamped database migrations.</p>
<p>This creates the &#8216;schema_migrations&#8217; table, drops the &#8216;migration&#8217; optionand adds the &#8216;omeka_version&#8217; option to the
database.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Returns:</th><td class="field-body">void</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::markAllAsMigrated">
<tt class="descname">markAllAsMigrated</tt><big>(</big><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::markAllAsMigrated" title="Permalink to this definition">¶</a></dt>
<dd><p>Mark all of the migrations as having been run.  Used by the installer as
a way of indicating that the database is entirely up to date.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Returns:</th><td class="field-body">void</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::migrate">
<tt class="descname">migrate</tt><big>(</big><em>string $endTimestamp</em><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::migrate" title="Permalink to this definition">¶</a></dt>
<dd><p>Migrate the database schema.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>$endTimestamp</strong> (<em>string</em>) &#8211; (optional) Timestamp corresponding to the stop point for the migration.  If older than the current time, database will migrate down to that point.  If newer, the opposite.  Defaults to the current timestamp.</li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">void</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::canUpgrade">
<tt class="descname">canUpgrade</tt><big>(</big><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::canUpgrade" title="Permalink to this definition">¶</a></dt>
<dd><p>Determine whether or not it is possible to migrate the Omeka database up.</p>
<p>This is based entirely on whether there exist any migrations that havenot yet been applied.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Returns:</th><td class="field-body">void</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::dbNeedsUpgrade">
<tt class="descname">dbNeedsUpgrade</tt><big>(</big><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::dbNeedsUpgrade" title="Permalink to this definition">¶</a></dt>
<dd><p>Determine whether the database must be upgraded.</p>
<p>In order to return true, this requires that canUprade() == true, and also that Omeka&#8217;s code has recently been
upgraded.</p>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::finalizeDbUpgrade">
<tt class="descname">finalizeDbUpgrade</tt><big>(</big><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::finalizeDbUpgrade" title="Permalink to this definition">¶</a></dt>
<dd><p>Finalize the database upgrade by setting the most up-to-date version
of Omeka.</p>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::getDefault">
<tt class="descname">getDefault</tt><big>(</big><em>Omeka_Db|null $db</em><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::getDefault" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the default configuration of the database migration manager.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>$db</strong> (<em>Omeka_Db|null</em>) &#8211; </li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Omeka_Db_Migration_Manager</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::_getAllMigratedVersions">
<tt class="descname">_getAllMigratedVersions</tt><big>(</big><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::_getAllMigratedVersions" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieve all the versions that have been migrated.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Returns:</th><td class="field-body">array</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::_getMigrationTableName">
<tt class="descname">_getMigrationTableName</tt><big>(</big><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::_getMigrationTableName" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the name of the table associated with schema migrations.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Returns:</th><td class="field-body">string</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::_getMigrationFileList">
<tt class="descname">_getMigrationFileList</tt><big>(</big><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::_getMigrationFileList" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a list of migration files in the migration directory.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Returns:</th><td class="field-body">array An associative array where key = timestamp of migration, value = full filename of the migration.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::_migrateUp">
<tt class="descname">_migrateUp</tt><big>(</big><em>DateTime $stopAt</em><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::_migrateUp" title="Permalink to this definition">¶</a></dt>
<dd><p>Migrate upwards to a specific timestamp.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>$stopAt</strong> (<em>DateTime</em>) &#8211; </li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">void</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::_loadMigration">
<tt class="descname">_loadMigration</tt><big>(</big><em>string $filename</em><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::_loadMigration" title="Permalink to this definition">¶</a></dt>
<dd><p>Require the migration file and return an instance of the class associated
with it.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>$filename</strong> (<em>string</em>) &#8211; Migration script filename.</li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Omeka_Db_Migration_AbstractMigration</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::_getPendingMigrations">
<tt class="descname">_getPendingMigrations</tt><big>(</big><em>DateTime $until</em><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::_getPendingMigrations" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieve a list of all migrations that have not been run yet, ending at
the latest time given by $until.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>$until</strong> (<em>DateTime</em>) &#8211; </li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">array</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="Omeka_Db_Migration_Manager::_recordMigration">
<tt class="descname">_recordMigration</tt><big>(</big><em>string $time</em><big>)</big><a class="headerlink" href="#Omeka_Db_Migration_Manager::_recordMigration" title="Permalink to this definition">¶</a></dt>
<dd><p>Record the migration timestamp in the schema_migrations table.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>$time</strong> (<em>string</em>) &#8211; </li>
</ul>
</td>
</tr>
<tr class="field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">void</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/logo-horizontal-200px.gif" alt="Logo"/>
            </a></p>
  <h3>This Page</h3>
  <p>See something wrong or confusing on this page?
    Please open an issue on <a href="https://github.com/omeka/OmekaDoc/issues.rst" rel="nofollow">Github</a>
    </p>
  <ul class="this-page-menu">
    
    <li><a href="https://github.com/omeka/OmekaDoc/master/sourceReference/libraries/Omeka/Db/Migration/Manager.rst"
           rel="nofollow">View Source</a>
    </li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
    
        <li><a href="../../../../../index.html">Omeka Documentation v2.0 documentation</a> &raquo;</li>
    <p style="background-color: white; color:red;">
    This documentation is currently unstable as changes continue to be made to Omeka 2.0.    
     The final release of Omeka 2.0 may have changes.</p>    
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Roy Rosenzweig Center for History and New Media.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>